<domain type="kvm" xmlns:qemu="http://libvirt.org/schemas/domain/qemu/1.0">
    <name>{{ libvirt_create_machine.name }}</name>
    <memory unit="GiB">{{ libvirt_create_machine.memory_gib }}</memory>
    <vcpu placement="static">{{ libvirt_create_machine.vcpus }}</vcpu>
    <metadata></metadata>
    <os firmware='efi'>
        <type arch="x86_64">hvm</type>
        <bios useserial="yes"/>
    </os>
    <features>
        <acpi/>
        <apic/>
        <pae/>
    </features>
    <cpu mode="{{ libvirt_create_machine.cpu_mode | default('host-model') }}">
        <model fallback="allow"/>
    </cpu>
    <clock offset="utc">
        <timer name="rtc" tickpolicy="catchup"/>
        <timer name="pit" tickpolicy="delay"/>
        <timer name="hpet" present="no"/>
    </clock>
    <on_crash>restart</on_crash>
    <on_poweroff>destroy</on_poweroff>
    <on_reboot>restart</on_reboot>
    <devices>
        <emulator>{{ qemu_emulator }}</emulator>

        <disk type="file" device="disk">
            <driver name="qemu" type="qcow2" cache="none"/>
            <source file="/var/lib/libvirt/images/{{ libvirt_create_machine.name }}/disk_vda.qcow2"/>
            <target dev="vda" bus="virtio"/>
            <boot order='1'/>
        </disk>

{% for data_disk in libvirt_create_machine.data_disks | default([]) %}
        <disk type="file" device="disk">
            <driver name="qemu" type="qcow2" cache="none"/>
            <source file="/var/lib/libvirt/images/{{ libvirt_create_machine.name }}/disk_{{ data_disk.device }}.qcow2"/>
            <target dev="{{ data_disk.device }}" bus="virtio"/>
        </disk>

{% endfor %}
{% if libvirt_create_machine.install_iso_path is defined %}
        <disk type='file' device='cdrom'>
            <driver name='qemu' type='raw'/>
            <source file='{{ libvirt_create_machine.install_iso_path }}'/>
            <target dev='sda' bus='sata'/>
            <readonly/>
            <boot order='2'/>
        </disk>

{% endif %}
{% if not (libvirt_create_machine.skip_cloudinit | default(skip_cloudinit)) %}
        <disk type='file' device='cdrom'>
            <driver name='qemu' type='raw'/>
            <source file='/var/lib/libvirt/images/{{ libvirt_create_machine.name }}/{{ libvirt_create_machine.name }}-cloudinit.iso'/>
{% if libvirt_create_machine.install_iso_path is defined %}
            <target dev='sdb' bus='sata'/>
{% else %}
            <target dev='sda' bus='sata'/>
{% endif %}
            <readonly/>
        </disk>

{% endif %}
{% for iface in libvirt_create_network_interfaces %}
{%   if iface.network_source is defined %}
        <interface type="{{ iface.network_type | default('bridge') }}">
            <source {{ iface.network_type | default('bridge') }}="{{ iface.network_source }}"/>
            <mac address="{{ iface.mac }}"/>
            <model type="virtio"/>
        </interface>
{%   else %}
        <interface type="ethernet">
            <target dev="{{ iface.ifname }}"/>
            <mac address="{{ iface.mac }}"/>
            <model type="virtio"/>
        </interface>
{%   endif %}
{% endfor %}

        <controller type="pci" index="0" model="pci-root"/>

        <serial type="pty">
            <target port="0"/>
        </serial>
        <console type="pty">
            <target type="serial" port="0"/>
        </console>

        <memballoon model="virtio"/>
        <rng model="virtio">
            <backend model="random">/dev/urandom</backend>
        </rng>
{% if libvirt_create_machine.vnc_port | default(False) %}
        <input type='tablet' bus='usb'/>
        <graphics type='vnc' port='{{ libvirt_create_machine.vnc_port }}' listen='{{ libvirt_create_machine.vnc_listen | default("127.0.0.1") }}'/>
        <video>
            <model type='vga'/>
        </video>
{% endif %}
    </devices>
{% if libvirt_create_machine.fw_cfg_name is defined and libvirt_create_machine.fw_cfg_file is defined %}
    <qemu:commandline>
        <qemu:arg value='-fw_cfg'/>
        <qemu:arg value='name={{ libvirt_create_machine.fw_cfg_name }},file={{ libvirt_create_machine.fw_cfg_file }}'/>
    </qemu:commandline>
{% endif %}
</domain>
