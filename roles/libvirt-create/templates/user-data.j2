#cloud-config
hostname: {{ libvirt_create_machine.name }}
fqdn: {{ libvirt_create_machine.fqdn | default(libvirt_create_machine.name) }}

{% set ssh_keys = libvirt_create_machine.ssh_keys | default(hypervisor_ssh_keys | default([])) %}
{% if ssh_keys | length > 0 %}
ssh_authorized_keys:
{% for key in ssh_keys %}
  - {{ key }}
{% endfor %}
{% endif %}

{% set root_password_hash = libvirt_create_machine.root_password_hash | default(cloudinit_root_password_hash | default(None)) %}
{% if root_password_hash %}
chpasswd:
  expire: false
  list:
    - root:{{ root_password_hash }}
{% endif %}

# Disable password authentication unless explicitly enabled
ssh_pwauth: {{ libvirt_create_machine.ssh_pwauth | default(false) }}

# Preserve cloud-init logs for debugging
output: {all: '| tee -a /var/log/cloud-init-output.log'}

{% if libvirt_create_machine.console_autologin | default(false) %}
# Configure serial console autologin for debugging
runcmd:
  - |
    mkdir -p /etc/systemd/system/serial-getty@ttyS0.service.d
    cat > /etc/systemd/system/serial-getty@ttyS0.service.d/autologin.conf <<'EOF'
    [Service]
    ExecStart=
    ExecStart=-/sbin/agetty -o '-p -f -- \\u' --noclear --autologin fedora %I $TERM
    EOF
  - systemctl daemon-reload
  - systemctl restart serial-getty@ttyS0.service
{% endif %}
